{% extends "base.html" %}

{% block content %}
<a href="{{ url_for('index') }}" class="inline-flex items-center gap-2 text-zinc-500 hover:text-zinc-900 mb-6 transition-colors">
  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
  </svg>
  Назад
</a>

{% set avatar_initial = post.author.display_name[0].upper() if post.author and post.author.display_name else post.author.username[0].upper() if post.author else '?' %}
<article class="border border-zinc-200 rounded-lg p-5 mb-8 bg-white">
  <div class="flex items-start gap-3 mb-4">
    <a href="{{ url_for('profile', username=post.author.username if post.author else 'unknown') }}">
      {% if post.author and post.author.avatar and post.author.avatar != 'default_avatar.png' %}
        <img src="{{ url_for('uploaded_file', filename=post.author.avatar) }}" 
          alt="Avatar" class="w-12 h-12 rounded-full object-cover bg-zinc-100">
      {% else %}
        <div class="w-12 h-12 rounded-full bg-zinc-200 flex items-center justify-center text-lg font-semibold text-zinc-500">
          {{ avatar_initial }}
        </div>
      {% endif %}
    </a>
    <div class="flex-1">
      <div class="flex items-center gap-2 flex-wrap">
        <a href="{{ url_for('profile', username=post.author.username if post.author else 'unknown') }}" class="font-medium hover:underline text-lg">
          {{ post.author.display_name if post.author else 'Unknown' }}
        </a>
        {% if post.author and post.author.is_verified %}
          <svg class="w-4 h-4 text-blue-500" fill="currentColor" viewBox="0 0 24 24">
            <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/>
          </svg>
        {% endif %}
        <span class="text-zinc-400 text-sm">@{{ post.author.username if post.author else 'unknown' }}</span>
      </div>
      <p class="text-sm text-zinc-400">{{ post.created_at[:10] if post.created_at else '' }}</p>
    </div>
    
    {% if current_user.is_authenticated and (current_user.id == post.user_id or is_admin) %}
      <div class="flex gap-2">
        {% if current_user.id == post.user_id %}
          <a href="{{ url_for('edit_post', post_id=post.id) }}" class="text-sm text-zinc-500 hover:text-zinc-900">Редактировать</a>
        {% endif %}
        <form action="{{ url_for('delete_post', post_id=post.id) }}" method="POST" onsubmit="return confirm('Удалить пост?')">
          <button type="submit" class="text-sm text-red-500 hover:text-red-700">Удалить</button>
        </form>
      </div>
    {% endif %}
  </div>
  
  <p class="whitespace-pre-wrap text-lg mb-4">{{ post.content }}</p>
  
  {% if post.media %}
    <div class="grid gap-2 mb-4 {% if post.media|length == 1 %}grid-cols-1 max-w-lg{% else %}grid-cols-2{% endif %}">
      {% for media in post.media %}
        <img src="{{ url_for('uploaded_file', filename=media) }}" alt="Media" 
          class="rounded-lg object-cover bg-zinc-100 w-full">
      {% endfor %}
    </div>
  {% endif %}
  
  {% if post.is_edited %}
    <p class="text-sm text-zinc-400 mb-4">(ред.)</p>
  {% endif %}
  
  <div class="flex items-center gap-4 py-3 border-t border-zinc-200 flex-wrap">
    {% if current_user.is_authenticated %}
      <form action="{{ url_for('react_to_post', post_id=post.id) }}" method="POST" class="inline">
        <input type="hidden" name="reaction_type" value="like">
        <button type="submit" class="flex items-center gap-1 hover:text-green-600 transition-colors {{ 'text-green-600' if user_reaction == 'like' else 'text-zinc-500' }}">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 20m7-10V5a2 2 0 00-2-2h-.095c-.5 0-.905.405-.905.905 0 .714-.211 1.412-.608 2.006L7 11v9m7-10h-2M7 20H5a2 2 0 01-2-2v-6a2 2 0 012-2h2.5"/>
          </svg>
          {{ post.reaction_count.like if post.reaction_count else 0 }}
        </button>
      </form>
      <form action="{{ url_for('react_to_post', post_id=post.id) }}" method="POST" class="inline">
        <input type="hidden" name="reaction_type" value="dislike">
        <button type="submit" class="flex items-center gap-1 hover:text-red-600 transition-colors {{ 'text-red-600' if user_reaction == 'dislike' else 'text-zinc-500' }}">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14H5.236a2 2 0 01-1.789-2.894l3.5-7A2 2 0 018.736 3h4.018a2 2 0 01.485.06l3.76.94m-7 10v5a2 2 0 002 2h.095c.5 0 .905-.405.905-.905 0-.714.211-1.412.608-2.006L17 13V4m-7 10h2m5-10h2a2 2 0 012 2v6a2 2 0 01-2 2h-2.5"/>
          </svg>
          {{ post.reaction_count.dislike if post.reaction_count else 0 }}
        </button>
      </form>
      <a href="{{ url_for('view_post', post_id=post.id) }}" class="text-zinc-500 hover:text-zinc-900 transition-colors flex items-center gap-1">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
        </svg>
        {{ post.comment_count }}
      </a>
      <form action="{{ url_for('report_content', type='post', id=post.id) }}" method="POST" onsubmit="return confirm('Пожаловаться?')" class="ml-auto">
        <button type="submit" class="text-zinc-400 hover:text-red-500 transition-colors">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 21v-4m0 0V5a2 2 0 012-2h6.5l1 1H21l-3 6 3 6h-8.5l-1-1H5a2 2 0 00-2 2zm9-13.5V9"/>
          </svg>
        </button>
      </form>
    {% else %}
      <span class="text-zinc-500 flex items-center gap-1">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 20m7-10V5a2 2 0 00-2-2h-.095c-.5 0-.905.405-.905.905 0 .714-.211 1.412-.608 2.006L7 11v9m7-10h-2M7 20H5a2 2 0 01-2-2v-6a2 2 0 012-2h2.5"/>
        </svg>
        {{ post.reaction_count.like if post.reaction_count else 0 }}
      </span>
      <span class="text-zinc-500 flex items-center gap-1">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14H5.236a2 2 0 01-1.789-2.894l3.5-7A2 2 0 018.736 3h4.018a2 2 0 01.485.06l3.76.94m-7 10v5a2 2 0 002 2h.095c.5 0 .905-.405.905-.905 0-.714.211-1.412.608-2.006L17 13V4m-7 10h2m5-10h2a2 2 0 012 2v6a2 2 0 01-2 2h-2.5"/>
        </svg>
        {{ post.reaction_count.dislike if post.reaction_count else 0 }}
      </span>
      <span class="text-zinc-500 flex items-center gap-1">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
        </svg>
        {{ post.comment_count }}
      </span>
    {% endif %}
  </div>
</article>

<h2 class="text-xl font-semibold mb-4">Комментарии ({{ comments|length }})</h2>

{% if current_user.is_authenticated %}
  <form action="{{ url_for('add_comment', post_id=post.id) }}" method="POST" enctype="multipart/form-data" class="mb-8">
    <textarea name="content" rows="3" placeholder="Напишите комментарий..." required
      class="w-full p-3 border border-zinc-300 rounded-lg focus:outline-none focus:border-zinc-900 mb-2"></textarea>
    
    <div class="flex items-center gap-4">
      <button type="submit" class="px-4 py-2 bg-zinc-900 text-white rounded-lg hover:bg-zinc-700 transition-colors">Отправить</button>
      
      <label class="flex items-center gap-2 text-sm text-zinc-500 cursor-pointer hover:text-zinc-700">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/>
        </svg>
        Прикрепить фото
        <input type="file" name="media" accept="image/*" class="hidden">
      </label>
    </div>
  </form>
{% else %}
  <p class="mb-8 text-zinc-500"><a href="{{ url_for('login') }}" class="underline hover:text-zinc-900">Войдите</a>, чтобы комментировать.</p>
{% endif %}

<div class="space-y-4">
  {% for comment in comments %}
    {% if not comment.is_deleted %}
      {% set comment_avatar_initial = comment.author.display_name[0].upper() if comment.author and comment.author.display_name else comment.author.username[0].upper() if comment.author else '?' %}
      <div class="border border-zinc-200 rounded-lg p-4 bg-white">
        <div class="flex items-start gap-3">
          <a href="{{ url_for('profile', username=comment.author.username if comment.author else 'unknown') }}">
            {% if comment.author and comment.author.avatar and comment.author.avatar != 'default_avatar.png' %}
              <img src="{{ url_for('uploaded_file', filename=comment.author.avatar) }}" 
                alt="Avatar" class="w-8 h-8 rounded-full object-cover bg-zinc-100">
            {% else %}
              <div class="w-8 h-8 rounded-full bg-zinc-200 flex items-center justify-center text-sm font-semibold text-zinc-500">
                {{ comment_avatar_initial }}
              </div>
            {% endif %}
          </a>
          <div class="flex-1">
            <div class="flex items-center gap-2 flex-wrap">
              <a href="{{ url_for('profile', username=comment.author.username if comment.author else 'unknown') }}" class="font-medium hover:underline">
                {{ comment.author.display_name if comment.author else 'Unknown' }}
              </a>
              <span class="text-zinc-400 text-sm">@{{ comment.author.username if comment.author else 'unknown' }}</span>
              <span class="text-zinc-400 text-sm">{{ comment.created_at[:10] if comment.created_at else '' }}</span>
            </div>
            <p class="mt-1">{{ comment.content }}</p>
            {% if comment.media %}
              <div class="mt-2">
                <img src="{{ url_for('uploaded_file', filename=comment.media[0]) }}" alt="Comment media" 
                  class="rounded-lg object-cover max-w-xs h-32">
              </div>
            {% endif %}
            {% if comment.is_edited %}<p class="text-xs text-zinc-400">(ред.)</p>{% endif %}
          </div>
          
          {% if current_user.is_authenticated and (current_user.id == comment.user_id or is_admin) %}
            <form action="{{ url_for('delete_comment', comment_id=comment.id) }}" method="POST" onsubmit="return confirm('Удалить?')">
              <button type="submit" class="text-sm text-red-500 hover:text-red-700">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
              </button>
            </form>
          {% endif %}
        </div>
      </div>
    {% endif %}
  {% endfor %}
</div>
{% endblock %}
